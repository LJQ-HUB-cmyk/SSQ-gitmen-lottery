# 🚀 立即部署指南

## ⚠️ 重要提示

代码已修复 `/init` 接口的错误，**需要立即重新部署**才能生效！

## 🔧 修复内容

- ✅ 修复 `/init` 接口的 `duration` 错误
- ✅ 改进数据库初始化逻辑
- ✅ 添加错误处理

## 📝 部署步骤

### 1. 进入目录

```bash
cd cloudflare-worker
```

### 2. 登录 Cloudflare（如果还没登录）

```bash
npx wrangler login
```

### 3. 部署

```bash
npx wrangler deploy
```

**预期输出**：
```
Published lottery-prediction (x.xx sec)
  https://lottery-prediction.githubmen.workers.dev
```

## ✅ 验证部署

### 测试 1：检查首页

```bash
export http_proxy="http://127.0.0.1:7897"
export https_proxy="http://127.0.0.1:7897"

curl -s "https://lottery-prediction.githubmen.workers.dev"
```

**预期**：显示接口列表

### 测试 2：测试 /init 接口

```bash
curl -X POST "https://lottery-prediction.githubmen.workers.dev/init" \
  -H "Authorization: Bearer d9464dbad6564438a37ff5245494152d" | jq '.'
```

**预期结果**：
```json
{
  "success": true,
  "message": "批量导入完成",
  "inserted": 100,
  "skipped": 0,
  "total": 100,
  "batch_size": 100
}
```

### 测试 3：查看统计

```bash
curl -s "https://lottery-prediction.githubmen.workers.dev/stats" | jq '.'
```

**预期**：显示数据统计

## 🎯 部署后操作

### 清空数据库（可选）

如果想从头开始，在 Cloudflare Dashboard 的 D1 Console 中执行：

```sql
DELETE FROM ssq_lottery;
```

### 运行初始化脚本

```bash
bash cloudflare-worker/scripts/init.sh
```

脚本会自动：
- 每次爬取 100 期
- 显示进度
- 自动去重
- 持续运行直到完成

## 📊 监控进度

在另一个终端窗口：

```bash
export http_proxy="http://127.0.0.1:7897"
export https_proxy="http://127.0.0.1:7897"

# 查看当前数据量
watch -n 10 'curl -s "https://lottery-prediction.githubmen.workers.dev/stats" | jq ".total_count"'
```

## 🎉 完成

部署完成后，系统将：
- ✅ `/init` 接口正常工作
- ✅ 可以批量导入数据
- ✅ 自动去重
- ✅ 显示详细进度

## 🐛 如果还有问题

1. **查看 Worker 日志**：
   - Cloudflare Dashboard > Workers > 你的 Worker > Logs

2. **检查绑定**：
   - 确保 D1 数据库已绑定
   - 确保 KV 命名空间已绑定

3. **重新创建表**：
   ```sql
   DROP TABLE IF EXISTS ssq_lottery;
   ```
   然后重新运行 `/init`

4. **联系支持**：
   - 查看文档：[cloudflare-worker/docs/](./cloudflare-worker/docs/)
   - 提交 Issue

---

**重要**：必须先部署，再运行 `init.sh`！

**版本**：2.0.1  
**修复时间**：2025-11-17
