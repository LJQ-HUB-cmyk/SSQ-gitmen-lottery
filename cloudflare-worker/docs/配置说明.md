# 配置说明

## 环境变量配置

### 1. Worker URL 和 API Key

```bash
# .env 文件
WORKER_URL=https://your-worker.workers.dev
API_KEY=your-api-key-here
```

### 2. 预测策略配置

```bash
# .env 文件
DEFAULT_STRATEGIES=frequency,balanced,coldHot
DEFAULT_PREDICTION_COUNT=15  # 3个策略，每个5条
```

**可用策略**：
- `frequency` - 频率策略（基于历史高频号码）
- `random` - 随机策略（完全随机）
- `balanced` - 均衡策略（追求号码分布均衡）
- `coldHot` - 冷热号策略（结合冷热号）

**配置示例**：
```bash
# 单个策略，默认5条
DEFAULT_STRATEGIES=frequency
DEFAULT_PREDICTION_COUNT=5

# 两个策略，10条（每个5条）
DEFAULT_STRATEGIES=frequency,balanced
DEFAULT_PREDICTION_COUNT=10

# 三个策略，15条（每个5条）
DEFAULT_STRATEGIES=frequency,balanced,coldHot
DEFAULT_PREDICTION_COUNT=15

# 所有策略，20条（每个5条）
DEFAULT_STRATEGIES=frequency,random,balanced,coldHot
DEFAULT_PREDICTION_COUNT=20
```

### 3. 爬取配置

```bash
# .env 文件
SLEEP_TIME=120              # 每次爬取间隔（秒）
DAILY_REQUEST_LIMIT=500     # 每日请求限制
AUTO_CONTINUE=false         # 是否自动跨天继续
```

## Wrangler 配置

### wrangler.toml

```toml
[vars]
ENVIRONMENT = "production"
DEFAULT_STRATEGIES = "frequency,balanced"  # 默认预测策略
DEFAULT_PREDICTION_COUNT = "10"            # 默认预测条数
```

## KV 存储配置

### 设置配置

```bash
# Telegram 配置
wrangler kv:key put --binding=KV_BINDING "TELEGRAM_BOT_TOKEN" "your-bot-token"
wrangler kv:key put --binding=KV_BINDING "TELEGRAM_CHAT_ID" "your-chat-id"

# API Key
wrangler kv:key put --binding=KV_BINDING "API_KEY" "your-api-key"

# 默认预测策略
wrangler kv:key put --binding=KV_BINDING "DEFAULT_STRATEGIES" "frequency,balanced"

# 默认预测条数
wrangler kv:key put --binding=KV_BINDING "DEFAULT_PREDICTION_COUNT" "10"
```

### 查看配置

```bash
wrangler kv:key get --binding=KV_BINDING "DEFAULT_STRATEGIES"
```

### 删除配置

```bash
wrangler kv:key delete --binding=KV_BINDING "DEFAULT_STRATEGIES"
```

## 配置优先级

配置读取优先级（从高到低）：

1. **API 请求参数** - 最高优先级
   ```bash
   curl "${WORKER_URL}/predict?strategies=random"
   ```

2. **KV 存储** - 运行时配置
   ```bash
   wrangler kv:key put --binding=KV_BINDING "DEFAULT_STRATEGIES" "frequency"
   ```

3. **环境变量** - 部署时配置
   ```toml
   # wrangler.toml
   [vars]
   DEFAULT_STRATEGIES = "frequency"
   ```

4. **代码默认值** - 最低优先级
   ```javascript
   // 默认值: frequency
   ```

## 快速配置脚本

### 设置预测策略和条数

```bash
# 使用脚本快速设置
./scripts/set-strategies.sh frequency,balanced,coldHot 15

# 参数说明：
# - 第1个参数：策略列表（逗号分隔）
# - 第2个参数：预测条数（可选，默认5）

# 脚本会自动更新：
# - wrangler.toml
# - KV 存储
# - .env 文件
```

## 配置验证

### 1. 查看当前配置

```bash
# 查看可用策略
curl "${WORKER_URL}/strategies"

# 测试预测（使用默认配置：策略+条数）
curl "${WORKER_URL}/predict"

# 或指定参数
curl "${WORKER_URL}/predict?count=5"
```

### 2. 测试不同策略

```bash
# 使用指定策略
curl "${WORKER_URL}/predict?count=5&strategies=random"

# 使用多个策略
curl "${WORKER_URL}/predict?count=10&strategies=frequency,balanced"
```

## 常见配置场景

### 场景1：保守型（推荐新手）

```bash
DEFAULT_STRATEGIES=frequency
DEFAULT_PREDICTION_COUNT=5
```

只使用频率策略，基于历史数据选择高频号码。

### 场景2：均衡型

```bash
DEFAULT_STRATEGIES=frequency,balanced
DEFAULT_PREDICTION_COUNT=10  # 每个策略5条
```

结合频率和均衡策略，既考虑历史数据，又追求分布均衡。

### 场景3：多样化

```bash
DEFAULT_STRATEGIES=frequency,balanced,coldHot
DEFAULT_PREDICTION_COUNT=15  # 每个策略5条
```

使用三种策略，生成多样化的预测组合。

### 场景4：完全随机

```bash
DEFAULT_STRATEGIES=random
DEFAULT_PREDICTION_COUNT=10
```

不考虑历史数据，完全随机生成。

## 配置更新流程

### 1. 本地开发环境

```bash
# 1. 修改 .env 文件
echo "DEFAULT_STRATEGIES=frequency,balanced" >> .env
echo "DEFAULT_PREDICTION_COUNT=10" >> .env

# 2. 测试
wrangler dev
```

### 2. 生产环境

```bash
# 1. 使用脚本更新配置
./scripts/set-strategies.sh frequency,balanced,coldHot 15

# 2. 重新部署
wrangler deploy

# 3. 验证（使用默认配置）
curl "${WORKER_URL}/predict"
```

## 故障排查

### 问题1：策略不生效

**检查步骤**：
1. 确认配置已更新：`wrangler kv:key get --binding=KV_BINDING "DEFAULT_STRATEGIES"`
2. 确认已重新部署：`wrangler deploy`
3. 查看日志：`wrangler tail`

### 问题2：无效的策略名称

**错误信息**：`未知的策略: xxx`

**解决方法**：
- 检查策略名称拼写
- 查看可用策略：`curl "${WORKER_URL}/strategies"`
- 确保没有多余的空格

### 问题3：配置未生效

**可能原因**：
1. 配置优先级问题（API 参数 > KV > 环境变量）
2. 未重新部署
3. KV 绑定配置错误

**解决方法**：
```bash
# 1. 清除 KV 配置（使用环境变量）
wrangler kv:key delete --binding=KV_BINDING "DEFAULT_STRATEGIES"

# 2. 重新部署
wrangler deploy

# 3. 测试
curl "${WORKER_URL}/predict?count=5"
```
