# 预测策略系统

## 概述

预测系统采用**策略模式**设计，支持多种预测策略的独立使用或组合使用。每个策略都是独立的单元，可以通过参数或配置灵活组装。

## 可用策略

### 1. 频率策略 (frequency)

**描述**：基于历史出现频率，选择高频号码组合

**策略**：
- 红球：70% 高频号码（前15个） + 30% 随机号码
  - 选择 4 个高频号码
  - 选择 2 个随机号码
- 蓝球：80% 概率选择高频（前5个），20% 概率随机

**适用场景**：相信"热号"会持续出现

### 2. 随机策略 (random)

**描述**：完全随机选择号码，不考虑历史数据

**策略**：
- 红球：从 1-33 中随机选择 6 个
- 蓝球：从 1-16 中随机选择 1 个

**适用场景**：相信每期开奖完全独立，历史数据无参考价值

### 3. 均衡策略 (balanced)

**描述**：追求号码分布均衡，从不同区间选择号码

**策略**：
- 红球：将 1-33 分为 3 个区间
  - 区间1 (01-11)：选择 2 个
  - 区间2 (12-22)：选择 2 个
  - 区间3 (23-33)：选择 2 个
- 蓝球：50% 高频，50% 随机

**适用场景**：追求号码分布的均衡性

### 4. 冷热号策略 (coldHot)

**描述**：结合热号、温号、冷号，追求冷热平衡

**策略**：
- 红球：
  - 热号（前10个高频）：选择 3 个
  - 温号（中间13个）：选择 2 个
  - 冷号（后10个低频）：选择 1 个
- 蓝球：60% 热号，30% 温号，10% 冷号

**适用场景**：相信冷热号会轮换出现

## 配置默认策略

### 方法1：通过环境变量配置（推荐）

在 `.env` 文件中设置：

```bash
# 单个策略
DEFAULT_STRATEGIES=frequency

# 多个策略（逗号分隔）
DEFAULT_STRATEGIES=frequency,balanced,coldHot
```

在 `wrangler.toml` 中设置：

```toml
[vars]
DEFAULT_STRATEGIES = "frequency,balanced"
```

### 方法2：通过 KV 存储配置

```bash
# 设置默认策略
wrangler kv:key put --binding=KV_BINDING "DEFAULT_STRATEGIES" "frequency,balanced"

# 查看当前配置
wrangler kv:key get --binding=KV_BINDING "DEFAULT_STRATEGIES"
```

### 优先级

配置读取优先级（从高到低）：
1. API 请求参数 `?strategies=xxx`
2. KV 存储的配置
3. 环境变量 `DEFAULT_STRATEGIES`
4. 代码默认值 `frequency`

## 使用方法

### 方法1：API 调用

#### 使用单个策略

```bash
# 使用频率策略生成 5 个组合
curl "${WORKER_URL}/predict?count=5&strategies=frequency"

# 使用随机策略生成 10 个组合
curl "${WORKER_URL}/predict?count=10&strategies=random"
```

#### 使用多个策略组合

```bash
# 组合使用频率策略和均衡策略
curl "${WORKER_URL}/predict?count=10&strategies=frequency,balanced"

# 组合使用所有策略
curl "${WORKER_URL}/predict?count=20&strategies=frequency,random,balanced,coldHot"
```

#### 使用默认策略

```bash
# 不指定策略，使用配置的默认策略
curl "${WORKER_URL}/predict?count=5"

# 如果配置了 DEFAULT_STRATEGIES=frequency,balanced
# 则会使用这两个策略各生成一半的组合
```

### 方法2：代码调用

```javascript
import { SSQPredictor } from './predictors/ssq.js';
import { Database } from './utils/database.js';

const db = new Database(env.DB);

// 使用默认策略
const predictor1 = new SSQPredictor(db);
const predictions1 = await predictor1.predict(5);

// 指定默认策略
const predictor2 = new SSQPredictor(db, {
  strategies: ['frequency', 'balanced']
});
const predictions2 = await predictor2.predict(10);

// 运行时指定策略
const predictor3 = new SSQPredictor(db);
const predictions3 = await predictor3.predict(10, ['coldHot', 'random']);
```

## 策略组合规则

### 组合方式

当使用多个策略时，系统会：
1. 计算每个策略应生成的组合数：`Math.ceil(总数 / 策略数)`
2. 依次使用每个策略生成组合
3. 自动去重（不会生成历史上出现过的组合）
4. 截取到指定总数

### 分配示例

#### 示例1：均匀分配（推荐）

```bash
# 生成 9 个组合，使用 3 个策略
curl "${WORKER_URL}/predict?count=9&strategies=frequency,balanced,coldHot"

# 计算：Math.ceil(9/3) = 3
# 结果：
# - frequency 策略: 3 个
# - balanced 策略: 3 个
# - coldHot 策略: 3 个
# - 总共: 9 个 ✅
```

#### 示例2：不均匀分配

```bash
# 生成 10 个组合，使用 3 个策略
curl "${WORKER_URL}/predict?count=10&strategies=frequency,balanced,coldHot"

# 计算：Math.ceil(10/3) = 4
# 生成：4 + 4 + 4 = 12 个
# 截取：前 10 个
# 结果：
# - frequency 策略: 4 个
# - balanced 策略: 4 个
# - coldHot 策略: 2 个（被截取）
# - 总共: 10 个 ✅
```

#### 示例3：count < 策略数（不推荐）

```bash
# 生成 1 个组合，使用 3 个策略
curl "${WORKER_URL}/predict?count=1&strategies=frequency,balanced,coldHot"

# 计算：Math.ceil(1/3) = 1
# 生成：frequency(1)
# 截取：前 1 个
# 结果：
# - frequency 策略: 1 个
# - 总共: 1 个 ⚠️ 只使用了第一个策略
```

### 最佳实践

**推荐配置**：
- 使用 1 个策略：`count` 任意
- 使用 2 个策略：`count` 为偶数（如 6, 10, 20）
- 使用 3 个策略：`count` 为 3 的倍数（如 9, 15, 30）
- 使用 4 个策略：`count` 为 4 的倍数（如 12, 20, 40）

**示例**：
```bash
# ✅ 推荐：均匀分配
curl "${WORKER_URL}/predict?count=12&strategies=frequency,balanced,coldHot"  # 每个4个

# ⚠️ 可用：不均匀但合理
curl "${WORKER_URL}/predict?count=10&strategies=frequency,balanced"  # 每个5个

# ❌ 不推荐：count太小
curl "${WORKER_URL}/predict?count=2&strategies=frequency,balanced,coldHot"  # 只用到2个策略
```

## 查看可用策略

```bash
# 获取所有可用策略列表
curl "${WORKER_URL}/strategies"

# 返回示例：
# [
#   {
#     "key": "frequency",
#     "name": "频率策略",
#     "description": "基于历史出现频率，选择高频号码组合"
#   },
#   {
#     "key": "random",
#     "name": "随机策略",
#     "description": "完全随机选择号码，不考虑历史数据"
#   },
#   ...
# ]
```

## 预测结果格式

```json
[
  {
    "rank": 1,
    "red_balls": ["03", "12", "15", "21", "28", "31"],
    "blue_ball": "08",
    "sorted_code": "03,12,15,21,28,31-08",
    "strategy": "frequency",
    "strategy_name": "频率策略",
    "prediction_time": "2025-11-17T10:30:00.000Z"
  },
  {
    "rank": 2,
    "red_balls": ["05", "11", "18", "22", "27", "33"],
    "blue_ball": "12",
    "sorted_code": "05,11,18,22,27,33-12",
    "strategy": "balanced",
    "strategy_name": "均衡策略",
    "prediction_time": "2025-11-17T10:30:00.000Z"
  }
]
```

## 添加自定义策略

### 步骤1：创建策略类

```javascript
// src/predictors/strategies/myStrategy.js
import { BaseStrategy } from './base.js';

export class MyStrategy extends BaseStrategy {
  constructor() {
    super(
      '我的策略',
      '策略描述'
    );
  }

  generateRedBalls(context) {
    // 实现红球生成逻辑
    const balls = [];
    // ... 你的逻辑
    return balls.sort();
  }

  generateBlueBall(context) {
    // 实现蓝球生成逻辑
    return '01';
  }
}
```

### 步骤2：注册策略

```javascript
// src/predictors/strategies/index.js
import { MyStrategy } from './myStrategy.js';

const STRATEGIES = {
  frequency: FrequencyStrategy,
  random: RandomStrategy,
  balanced: BalancedStrategy,
  coldHot: ColdHotStrategy,
  myStrategy: MyStrategy  // 添加新策略
};
```

### 步骤3：使用新策略

```bash
curl "${WORKER_URL}/predict?count=5&strategies=myStrategy"
```

## 策略上下文数据

每个策略的 `generateRedBalls` 和 `generateBlueBall` 方法都会接收一个 `context` 对象，包含：

```javascript
{
  historyData: [],           // 历史数据（最近500期）
  redFrequency: [],          // 红球频率统计
  blueFrequency: [],         // 蓝球频率统计
  historicalCombinations: Set  // 历史组合（用于去重）
}
```

## 最佳实践

### 1. 单一策略

适合对某种策略有信心的场景：
```bash
curl "${WORKER_URL}/predict?count=5&strategies=frequency"
```

### 2. 策略组合

适合希望多样化的场景：
```bash
curl "${WORKER_URL}/predict?count=10&strategies=frequency,balanced,coldHot"
```

### 3. 大量生成

生成大量组合时，建议使用多个策略以提高多样性：
```bash
curl "${WORKER_URL}/predict?count=50&strategies=frequency,random,balanced,coldHot"
```

## 注意事项

1. **去重机制**：系统会自动过滤历史上出现过的组合
2. **有效性验证**：所有组合都会验证有效性（如不超过3个连号）
3. **生成限制**：每个策略最多尝试 `count * 100` 次，避免无限循环
4. **策略顺序**：多个策略按指定顺序依次执行

## 常见问题

### Q1: 如何选择合适的策略？

**建议**：
- 新手：使用 `frequency`（频率策略）
- 追求均衡：使用 `balanced`（均衡策略）
- 相信冷热轮换：使用 `coldHot`（冷热号策略）
- 完全随机：使用 `random`（随机策略）
- 多样化：组合多个策略

### Q2: 策略组合的顺序重要吗？

**答**：不重要。系统会依次使用每个策略生成组合，最终结果会混合在一起。

### Q3: 可以自定义每个策略生成的数量吗？

**答**：目前系统会平均分配。如需自定义，可以多次调用 API：
```bash
# 频率策略生成 7 个
curl "${WORKER_URL}/predict?count=7&strategies=frequency"

# 均衡策略生成 3 个
curl "${WORKER_URL}/predict?count=3&strategies=balanced"
```

### Q4: 策略会保证不重复吗？

**答**：是的。系统会自动过滤：
1. 历史上出现过的组合
2. 本次预测中已生成的组合
