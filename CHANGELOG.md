# 更新日志

## [2.0.1] - 2025-11-17

### 🐛 Bug 修复

#### /init 接口错误修复
- 修复 `Cannot read properties of undefined (reading 'duration')` 错误
- 将 `db.exec()` 改为 `prepare().run()`
- 改进错误处理

**影响范围**：
- Cloudflare Worker 版本的 `/init` 接口

**修复文件**：
- `cloudflare-worker/src/utils/database.js`

---

## [2.0.0] - 2025-11-17

### 🎉 重大更新

#### 双数据源支持
- ✅ 添加 500.com 作为备用数据源
- ✅ 主源（中彩网）失败时自动切换到备用源
- ✅ 提高数据获取成功率和稳定性
- ✅ 两个版本（Python 和 Cloudflare Worker）都已支持

#### 全量爬取修复
- ✅ 移除 1000 条的限制
- ✅ 支持获取所有历史数据（4000+ 期）
- ✅ 自动去重，可重复执行
- ✅ 明确的批次控制（每次 100 期）

#### 增量更新优化
- ✅ 修复漏数据的严重漏洞
- ✅ 从数据库最新期号往后爬（而不是从线上最新往前）
- ✅ 避免漏掉中间的数据
- ✅ 智能检测，自动补全缺失数据

#### 接口设计优化
- ✅ `/init` 专注批量导入历史数据
- ✅ `/run` 专注增量更新最新数据
- ✅ 逻辑清晰，职责分离，互不干扰

### 📝 详细改进

#### Cloudflare Worker 版本

**新增功能**：
- 双数据源爬虫（`src/spiders/ssq.js`）
- 自动切换机制
- HTML 解析支持（500.com）
- 改进的错误处理

**接口变更**：
- `/init` - 批量导入模式，每次 100 期，自动去重
- `/run` - 增量更新模式，从数据库最新往后爬

**脚本工具**：
- `scripts/init.sh` - 初始化脚本（支持代理）
- `scripts/diagnose.sh` - 诊断工具
- `scripts/test-connection.sh` - 连接测试

**文档**：
- `docs/快速开始.md` - 三步完成初始化
- `docs/接口设计说明.md` - 接口设计理念
- `docs/增量更新逻辑修复.md` - 漏洞修复说明

#### Python 版本

**新增方法**：
- `fetch_latest()` - 获取最新数据（自动切换数据源）
- `fetch_latest_from_500com()` - 从 500.com 获取数据
- `fetch_incremental()` - 增量更新（从数据库最新往后爬）

**改进方法**：
- `crawl_all()` - 支持真正的全量爬取
- `fetch_api_recent()` - 改进错误处理

**测试**：
- `test_spider.py` - 完整的测试脚本
- 测试所有数据源和切换机制

### 🗂️ 项目结构优化

**文档整理**：
- 创建 `docs/fixes/` 目录存放修复文档
- 创建 `cloudflare-worker/docs/` 存放 Worker 文档
- 创建 `cloudflare-worker/scripts/` 存放脚本文件

**新增文档**：
- `PROJECT_STRUCTURE.md` - 项目结构说明
- `README.md` - 更新主文档
- `CHANGELOG.md` - 本文档

**清理**：
- 删除重复和过时的文档
- 删除空目录
- 整理文件结构

### 🐛 Bug 修复

1. **增量更新漏数据**
   - 问题：从最新往前爬，遇到已存在就停止
   - 修复：从数据库最新往后爬，逐个检查

2. **全量爬取限制**
   - 问题：只能获取 1000 期数据
   - 修复：移除限制，支持所有历史数据

3. **数据源单点故障**
   - 问题：只有一个数据源，失败就无法获取数据
   - 修复：添加备用数据源，自动切换

4. **初始化逻辑混乱**
   - 问题：初始化和增量更新逻辑混在一起
   - 修复：完全分离，各司其职

### 📊 性能优化

- 批次大小优化（100 期/批）
- 请求延迟控制（防止被封）
- 自动去重机制
- 错误重试机制

### 🔒 安全改进

- API 认证
- 代理支持
- 错误处理
- 日志记录

## [1.0.0] - 2025-11-16

### 初始版本

- 基础爬虫功能
- 预测算法
- Telegram 通知
- Cloudflare Worker 支持

---

## 版本说明

版本号格式：`主版本.次版本.修订号`

- **主版本**：重大架构变更
- **次版本**：新功能添加
- **修订号**：Bug 修复

## 贡献者

感谢所有贡献者的付出！

特别感谢用户发现的关键漏洞：
- 增量更新漏数据问题
- 全量爬取限制问题

---

**最后更新**：2025-11-17
